# Code Explanation

## Patch: Next.js Proxy-Only Middleware Fix (codex/frontend-auth-gating-mvp1)

### Overview
This patch resolves a Next.js build failure caused by having both `src/proxy.ts` and `src/middleware.ts`.
In Next.js 16, this project must use `src/proxy.ts` only for middleware/proxy behavior.

### Files Changed

#### `src/middleware.ts` (removed)
- Deleted the shim file to avoid dual-detection conflict:
  - `Both middleware file ... and proxy file ... are detected. Please use ... proxy.ts only.`
- `src/proxy.ts` remains the single source for Clerk middleware handler and matcher config.

---

## Patch: Clerk Middleware Coverage Fix (codex/frontend-auth-gating-mvp1)

### Overview
This patch fixes a production server error by ensuring Clerk middleware runs on frontend page requests (not only API routes).
Without this, server-side calls like `auth()` and `currentUser()` on pages can fail at runtime in Vercel.

### Files Changed

#### `src/proxy.ts`
- Updated `config.matcher` from API-only to page+API coverage.
- New matcher behavior:
  - Includes app/page routes.
  - Includes `/api` and `/trpc` routes.
  - Excludes `_next` internals and static assets.
- This keeps Clerk session context available for frontend route gating and restricted-access pages.

---

## PR: Frontend Auth Flow & Route Protection (codex/frontend-auth-gating-mvp1)

### Overview
This PR adds frontend-only protection for app pages using Clerk in the Next.js App Router.
It enforces that protected pages are accessible only to users who are:
- signed in
- using a verified email
- using a verified `@stetson.edu` email

If a signed-in user is blocked (unverified or non-stetson), they are redirected to a dedicated `Access Restricted` UX page with clear next actions.

---

### Files Changed

#### `src/app/page.tsx` -> moved to `src/app/(protected)/page.tsx`
- The root homepage is now placed inside a protected route group.
- This preserves route URL (`/`) while making it subject to the protected layout guard.
- The page content itself was not functionally changed; only route organization changed for gating.

#### `src/app/(protected)/layout.tsx`
- Adds centralized frontend route protection for everything in the `(protected)` group.
- **`const user = await currentUser();`**
  - Reads Clerk session on the server for the current request.
- **`if (!user) redirect("/sign-in");`**
  - Ensures signed-out users are redirected to Clerk sign-in before protected content renders.
- **`const access = evaluateFrontendAccess(user);`**
  - Runs frontend authorization logic (verified + stetson email check).
- **`if (!access.allowed) redirect("/access-restricted?...")`**
  - Redirects unauthorized signed-in users to the blocked-user UX with a reason code in query params.
- **`return <>{children}</>;`**
  - Renders protected content only when both auth and authorization pass.

#### `src/lib/frontend-auth.ts`
- New frontend authorization utility used by protected layouts/pages.
- **`RestrictionReason`**
  - Enumerates explicit blocked states: missing email, unverified email, non-stetson domain.
- **`evaluateFrontendAccess(user)`**
  - Core decision function:
    1. Rejects missing user/email list.
    2. Requires at least one verified email.
    3. Requires at least one verified email ending with `@stetson.edu`.
    4. Returns success with normalized verified stetson email.
- **`getRestrictionCopy(reason)`**
  - Maps block reasons to user-facing text for the restricted page.

#### `src/app/access-restricted/page.tsx`
- Implements the blocked-user UX page required for frontend authorization failures.
- **Server `searchParams` parsing + reason validation**
  - Reads reason code passed by protected layout via page `searchParams` and validates it to known values.
- **Requirement message block**
  - Explains that a verified `@stetson.edu` email is required.
- **Action buttons**
  - `Sign out` (Clerk `SignOutButton` with redirect to `/sign-in`)
  - `Switch account` is conditional:
    - Signed in: Clerk `UserButton` for account/session switching
    - Signed out: link to `/sign-in`
  - `Verify email` (link to `/user-profile`)
- This page is intentionally minimal and consistent with existing app styling.

#### `src/app/user-profile/[[...user-profile]]/page.tsx`
- Adds a Clerk-hosted profile route so blocked users have a direct place to manage/verify email.
- **`<SignedIn><UserProfile ... /></SignedIn>`**
  - Shows profile only for authenticated users.
- **`<SignedOut><RedirectToSignIn /></SignedOut>`**
  - Prevents anonymous access and sends signed-out users to sign-in.

---

### Scope Confirmation
- Implemented: frontend auth flow and route protection.
- Implemented: Clerk-based gating for protected pages.
- Implemented: blocked-user access UX with required actions.
- Not implemented: backend guard changes, `/api/*` behavior changes, business logic/model changes.

---

## PR: Backend Authentication & Authorization (feat/backend-auth)

### Overview
This PR implements backend authentication and authorization enforcement for MVP 1.
All protected API routes require a valid Clerk session AND a verified @stetson.edu email.

---

### Files Changed

#### `.env.local` / `.env.example`
- **`.env.local`**: Contains the actual environment variable values (gitignored).
- **`.env.example`**: Committed reference showing all required environment variables.
- Variables:
  - `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` — Clerk publishable key (used client-side)
  - `CLERK_SECRET_KEY` — Clerk secret key (used server-side)
  - `NEXT_PUBLIC_CLERK_SIGN_IN_URL` / `NEXT_PUBLIC_CLERK_SIGN_UP_URL` — Clerk redirect URLs
  - `DATABASE_URL` — PostgreSQL connection string for Prisma

#### `prisma/schema.prisma`
- Defines the PostgreSQL datasource and Prisma client generator.
- **`User` model**: Local user record linked to Clerk.
  - `id` — UUID primary key (auto-generated).
  - `clerkUserId` — Unique string mapped from Clerk's user ID (`clerk_user_id` column). Ensures one local record per Clerk user.
  - `email` — The user's verified @stetson.edu email address.
  - `createdAt` / `updatedAt` — Timestamps for record creation and last update.
  - `@@map("users")` — Maps the model to a `users` table in PostgreSQL.

#### `prisma.config.ts`
- Auto-generated Prisma config. Loads `DATABASE_URL` from environment via `dotenv/config`.
- Points to `prisma/schema.prisma` and `prisma/migrations` directory.

#### `src/lib/prisma.ts`
- **Singleton Prisma client**.
- Uses `globalThis` caching to prevent multiple PrismaClient instances during Next.js dev hot-reloads.
- `globalForPrisma.prisma` stores the client globally; in production, a fresh instance is created per cold start.

#### `src/lib/auth.ts`
- **`requireStetsonAuth()`** — The core auth guard function.
- **Step 1**: Calls `currentUser()` from `@clerk/nextjs/server` to get the Clerk session user.
  - If `null` → returns `NextResponse` with **401** and `"Authentication required."` message.
- **Step 2**: Iterates `user.emailAddresses` looking for an email where:
  - `verification.status === "verified"` — Email must be verified through Clerk.
  - `emailAddress.toLowerCase().endsWith("@stetson.edu")` — Must be a Stetson University email (case-insensitive).
  - If no matching email → returns `NextResponse` with **403** and `"Access restricted to verified @stetson.edu email addresses."` message.
- **Step 3**: Returns `AuthedUser` object with `clerkUserId` and `primaryStetsonEmail`.
- **Type `AuthResult`**: Discriminated union — either `{ user: AuthedUser }` or `{ error: NextResponse }`. Enables clean pattern matching in route handlers.

#### `src/middleware.ts`
- Exports `clerkMiddleware()` from `@clerk/nextjs/server`.
- **Purpose**: Makes Clerk auth state (session, user) available to all matched routes. Without this, `currentUser()` would return `null` for every request.
- **`config.matcher`**: Applies to all `/api/(.*)` routes and non-static pages. Skips Next.js internals (`_next`) and static assets (images, fonts, etc.).
- **Note**: This middleware does NOT enforce authorization — it only provides session data. Authorization is enforced per-route by `requireStetsonAuth()`.

#### `src/app/layout.tsx`
- Wraps the entire app with `<ClerkProvider>` — required for Clerk to manage sessions.
- Updates metadata title/description to "Desti".
- **Note**: This is the only frontend file touched, and it's the minimal change needed for Clerk to function. No frontend route protection or UI logic is added.

#### `src/app/api/me/route.ts`
- **`GET /api/me`** — Returns the current user's profile.
- **Line-by-line**:
  1. Calls `requireStetsonAuth()` — if it returns an error, that error response is returned immediately (401 or 403).
  2. Calls `prisma.user.findUnique({ where: { clerkUserId } })` to check if a local user already exists.
  3. Calls `prisma.user.upsert()` with:
     - `where: { clerkUserId }` — Matches on the unique Clerk ID.
     - `create: { clerkUserId, email }` — Creates the user if missing.
     - `update: { email }` — Keeps the email in sync if user already exists.
  4. Sets `created = !existingUser` — `true` if this was the first call for this user.
  5. Returns JSON with `clerkUserId`, `primaryVerifiedEmail`, `created`, and `localUser` (safe fields only: id, clerkUserId, email, createdAt, updatedAt).
- **Idempotency**: `upsert` ensures no duplicate users are created even under concurrent requests.

#### `src/app/api/health/route.ts`
- **`GET /api/health`** — Public health-check endpoint. No authentication required.
- Returns `{ status: "ok", timestamp: "..." }`.
- Useful for uptime monitoring, load balancer health checks, and deployment verification.

#### `.gitignore`
- Updated to allow `.env.example` to be committed while still excluding `.env`, `.env.local`, and `*.local` env files.

---

### API Responses Summary

| Endpoint | Auth Required | 401 When | 403 When | 200 Response |
|-----------|--------------|----------|----------|-------------|
| `GET /api/health` | No | — | — | `{ status, timestamp }` |
| `GET /api/me` | Yes | No Clerk session | No verified @stetson.edu email | `{ clerkUserId, primaryVerifiedEmail, created, localUser }` |

---

## 2026-02-12 — Ride Creation (POST /api/rides)

### Overview
This PR implements the ride creation endpoint for MVP 1. Drivers with verified @stetson.edu emails can create rides. The endpoint enforces comprehensive validation, uses idempotency keys to prevent duplicate rides under retries/concurrency, and derives server-side fields (driverUserId, seatsAvailable, status) from auth context and business rules.

---

### Files Changed

#### `prisma/schema.prisma`
- **`DistanceCategory` enum** — Defines `SHORT`, `MEDIUM`, `LONG` values. Used by the `Ride` model to categorize trip distance.
- **`RideStatus` enum** — Defines `ACTIVE` for MVP 1. Room to add `CANCELLED`, `COMPLETED` later.
- **`Ride` model** — Mapped to `rides` table. Contains:
  - `id` — UUID primary key (auto-generated).
  - `driverUserId` — Clerk user ID of the driver. FK to `User.clerkUserId`.
  - `originText` / `destinationText` — Trimmed text strings for origin and destination (3–200 chars).
  - `earliestDepartAt` / `latestDepartAt` — Departure time window (validated: latest > earliest, window ≤ 48h, earliest ≥ now − 10min).
  - `distanceCategory` — Enum value (`SHORT` | `MEDIUM` | `LONG`).
  - `priceCents` — Integer price in cents (≥ 0).
  - `seatsTotal` / `seatsAvailable` — Integer seats (1–8). `seatsAvailable` initialized to `seatsTotal` on create.
  - `status` — Defaults to `ACTIVE`.
  - `createdAt` / `updatedAt` — Auto-managed timestamps.
  - `driver` relation — Links to User via `driverUserId` → `User.clerkUserId`.
  - `idempotencyKeys` relation — Back-relation to `IdempotencyKey`.
- **`IdempotencyKey` model** — Mapped to `idempotency_keys` table. Contains:
  - `id` — UUID primary key.
  - `driverUserId` — Clerk user ID.
  - `idempotencyKey` — Client-provided idempotency key string.
  - `rideId` — FK to the `Ride` created with this key.
  - `createdAt` — Timestamp.
  - `@@unique([driverUserId, idempotencyKey])` — Composite unique constraint. **This is the concurrency safety mechanism** — prevents two rides from being created for the same driver + key, even under concurrent requests.
- **`User` model** — Added `rides Ride[] @relation("DriverRides")` back-relation.

#### `prisma/migrations/20260212190911_add_ride_and_idempotency_models/migration.sql`
- Auto-generated Prisma migration that:
  - Creates `DistanceCategory` and `RideStatus` enums in PostgreSQL.
  - Creates the `rides` table with all columns and FK to `users.clerk_user_id`.
  - Creates the `idempotency_keys` table with FK to `rides.id`.
  - Adds unique index on `(driver_user_id, idempotency_key)`.

#### `src/app/api/rides/route.ts`
- **`POST` handler** — The main endpoint implementation. Flow:
  1. **Auth guard** (`requireStetsonAuth()`) — Rejects unauthenticated (401) or non-stetson (403) users. Derives `driverUserId` from `auth.user.clerkUserId`. Client-supplied `driverUserId` is explicitly deleted from the body.
  2. **Idempotency-Key header** — Read from `request.headers.get("Idempotency-Key")`. If missing or empty after trim → 400.
  3. **Body parsing** — `request.json()` wrapped in try/catch for invalid JSON → 400.
  4. **`validateRideBody(body)`** — Returns `{ errors, parsed }`. If errors exist → 400 with `{ error, message, details }` where `details` is an array of `{ field, message }` objects.
  5. **Idempotency check** — `prisma.idempotencyKey.findUnique()` with composite key `(driverUserId, idempotencyKey)`. If found → return the associated ride with **200** (replay).
  6. **User upsert** — `prisma.user.upsert()` ensures a local User record exists before creating the ride. Required because `rides.driver_user_id` has a FK to `users.clerk_user_id`. Idempotent — creates on first call, syncs email on subsequent calls.
  7. **Ride creation** — `prisma.ride.create()` with derived fields: `seatsAvailable = seatsTotal`, `status = "ACTIVE"`.
  8. **Idempotency mapping creation** — `prisma.idempotencyKey.create()` inside try/catch. If P2002 unique constraint violation (race condition) → fetch existing mapping and return ride with **200**.
  9. **201 response** — Return created ride JSON.
  10. **500 catch-all** — Logs unexpected errors, returns generic error response.
- **`validateRideBody(body)`** — Validation function. Returns field-level error array:
  - `originText` / `destinationText` — Must be strings, trimmed, 3–200 chars.
  - `earliestDepartAt` / `latestDepartAt` — Must parse as valid Date objects.
  - Cross-field: `latestDepartAt > earliestDepartAt`, window ≤ 48h.
  - `earliestDepartAt ≥ now − 10 minutes` (clock skew grace).
  - `distanceCategory` — Must be in `DistanceCategory` enum set.
  - `priceCents` — Integer ≥ 0.
  - `seatsTotal` — Integer 1–8.
- **`isPrismaUniqueConstraintError(err)`** — Type guard checking for Prisma error code `P2002`. Used in the idempotency conflict handler.

#### `src/__tests__/ride-create.test.ts`
- **Test file** — 7 unit tests using Vitest with mocked auth and Prisma:
  1. `returns 201 with created ride on successful create` — Verifies status, ride ID, driverUserId, seatsAvailable, and status in response.
  2. `returns 400 when Idempotency-Key header is missing` — Request has no Idempotency-Key header.
  3. `returns 400 when earliestDepartAt is after latestDepartAt` — earliest 5h from now, latest 1h from now.
  4. `returns 400 when departure window exceeds 48 hours` — 49h gap between earliest and latest.
  5. `returns 400 when seatsTotal is outside 1-8 range` — seatsTotal = 10.
  6. `returns 400 when priceCents is negative` — priceCents = -100.
  7. `returns 200 with existing ride on idempotency replay` — Mock returns existing mapping, verifies same ride ID returned and no new ride created.
- **Mock setup** — Uses `vi.hoisted()` to declare mock objects before `vi.mock()` factory functions (which are hoisted). Mocks: `requireStetsonAuth`, `prisma`, and `DistanceCategory` enum.
- **Helpers** — `validBody()` builds a valid request body, `makeRequest()` builds a Request object, `successAuth()` returns mock auth, `fakeRide()` returns a mock Ride object.

#### `vitest.config.ts`
- Vitest configuration file. Sets test environment to `node` and configures `@/` path alias to resolve to `./src/` (matches `tsconfig.json` paths).

#### `package.json`
- Added `"test": "vitest run"` script.
- Added `vitest` as a devDependency.


## Patch: Trip Request Creation Endpoint (feature/trip-request-create-idempotency)

### Overview
Adds POST /api/trip-requests — a rider-authored trip request endpoint for MVP 1.
Also generalizes the idempotency_keys table to support both rides and trip requests,
avoiding a redundant parallel idempotency system.

### Files Changed

#### `prisma/schema.prisma`
- **TripRequestStatus enum**: ACTIVE, CANCELLED (CANCELLED in schema only; no cancellation endpoint).
- **IdempotencyEntityType enum**: RIDE, TRIP_REQUEST — discriminator for the shared idempotency table.
- **TripRequest model**: riderUserId (FK → users.clerk_user_id), originText, destinationText,
  earliestDesiredAt, latestDesiredAt, distanceCategory, seatsNeeded, status, timestamps.
  Mapped to `trip_requests` table.
- **IdempotencyKey model changes**:
  - `driverUserId` → `userId` (column `user_id`) — now generic for any user.
  - Added `entityType` — discriminates between RIDE and TRIP_REQUEST entries.
  - `rideId` → optional (nullable) for trip request entries.
  - Added optional `tripRequestId` (FK → trip_requests.id).
  - Unique constraint changed from `(driverUserId, idempotencyKey)` to `(userId, idempotencyKey, entityType)`.
- **User model**: Added `tripRequests` back-relation.

#### `prisma/migrations/.../migration.sql`
- Custom migration with data-migration steps:
  1. Creates enums + trip_requests table.
  2. Adds `user_id` and `entity_type` as nullable columns.
  3. Migrates existing rows: copies `driver_user_id` → `user_id`, sets `entity_type` = 'RIDE'.
  4. Sets new columns to NOT NULL.
  5. Drops old `driver_user_id` column, makes `ride_id` nullable.
  6. Creates new unique index and foreign keys.

#### `src/app/api/rides/route.ts` (minimal required update)
- All IdempotencyKey queries updated: `driverUserId` → `userId`, added `entityType: "RIDE"`.
- Compound unique key references changed from `driverUserId_idempotencyKey` to `userId_idempotencyKey_entityType`.
- No changes to ride business logic.

#### `src/app/api/trip-requests/route.ts` (new file)
Handler follows the same architecture as rides/route.ts:
1. **Auth guard** — `requireStetsonAuth()`, derives `riderUserId = auth.user.clerkUserId`.
2. **Idempotency-Key header** — required, trimmed, 400 if missing.
3. **JSON body parsing** — type guard rejects non-object JSON (null/arrays/primitives).
4. **Client riderUserId rejected** — `delete body.riderUserId` prevents client override.
5. **Validation** — `validateTripRequestBody()`:
   - originText/destinationText: string, trimmed, 3–200 chars.
   - earliestDesiredAt/latestDesiredAt: valid ISO datetimes.
   - latestDesiredAt > earliestDesiredAt (strict).
   - Desired window ≤ 48h.
   - earliestDesiredAt ≥ now - 10min (clock skew grace).
   - distanceCategory: SHORT | MEDIUM | LONG.
   - seatsNeeded: integer 1–8.
6. **Idempotency check** — `findUnique` with `entityType: "TRIP_REQUEST"`. Returns 200 on replay.
7. **User upsert** — ensures User record exists for FK satisfaction.
8. **Atomic transaction** — `prisma.$transaction` creates TripRequest + IdempotencyKey together.
   P2002 rolls back the trip request (no orphans).
9. **P2002 catch** — fetches existing mapping, returns 200.
10. **Success** — returns 201 with created TripRequest.

#### `src/__tests__/ride-create.test.ts`
- Updated idempotency replay mock data: `driverUserId` → `userId`, added `entityType: "RIDE"`.

#### `src/__tests__/trip-request-create.test.ts` (new file)
Seven test cases:
  1. `returns 201 with created trip request on successful create` — verifies $transaction atomicity.
  2. `returns 400 when Idempotency-Key header is missing`.
  3. `returns 400 when earliestDesiredAt is after latestDesiredAt`.
  4. `returns 400 when desired window exceeds 48 hours`.
  5. `returns 400 when seatsNeeded is outside 1-8 range`.
  6. `returns 400 when distanceCategory is invalid` — tests "VERY_FAR" rejected.
  7. `returns 200 with existing trip request on idempotency replay`.
Mock setup mirrors ride tests: `vi.hoisted()` for mock objects, mocks for auth/prisma/DistanceCategory.

