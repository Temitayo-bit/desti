# Code Explanation

## PR: Frontend Auth Flow & Route Protection (codex/frontend-auth-gating-mvp1)

### Overview
This PR adds frontend-only protection for app pages using Clerk in the Next.js App Router.
It enforces that protected pages are accessible only to users who are:
- signed in
- using a verified email
- using a verified `@stetson.edu` email

If a signed-in user is blocked (unverified or non-stetson), they are redirected to a dedicated `Access Restricted` UX page with clear next actions.

---

### Files Changed

#### `src/app/page.tsx` -> moved to `src/app/(protected)/page.tsx`
- The root homepage is now placed inside a protected route group.
- This preserves route URL (`/`) while making it subject to the protected layout guard.
- The page content itself was not functionally changed; only route organization changed for gating.

#### `src/app/(protected)/layout.tsx`
- Adds centralized frontend route protection for everything in the `(protected)` group.
- **`const user = await currentUser();`**
  - Reads Clerk session on the server for the current request.
- **`if (!user) redirect("/sign-in");`**
  - Ensures signed-out users are redirected to Clerk sign-in before protected content renders.
- **`const access = evaluateFrontendAccess(user);`**
  - Runs frontend authorization logic (verified + stetson email check).
- **`if (!access.allowed) redirect("/access-restricted?...")`**
  - Redirects unauthorized signed-in users to the blocked-user UX with a reason code in query params.
- **`return <>{children}</>;`**
  - Renders protected content only when both auth and authorization pass.

#### `src/lib/frontend-auth.ts`
- New frontend authorization utility used by protected layouts/pages.
- **`RestrictionReason`**
  - Enumerates explicit blocked states: missing email, unverified email, non-stetson domain.
- **`evaluateFrontendAccess(user)`**
  - Core decision function:
    1. Rejects missing user/email list.
    2. Requires at least one verified email.
    3. Requires at least one verified email ending with `@stetson.edu`.
    4. Returns success with normalized verified stetson email.
- **`getRestrictionCopy(reason)`**
  - Maps block reasons to user-facing text for the restricted page.

#### `src/app/access-restricted/page.tsx`
- Implements the blocked-user UX page required for frontend authorization failures.
- **Server `searchParams` parsing + reason validation**
  - Reads reason code passed by protected layout via page `searchParams` and validates it to known values.
- **Requirement message block**
  - Explains that a verified `@stetson.edu` email is required.
- **Action buttons**
  - `Sign out` (Clerk `SignOutButton`)
  - `Switch account` (link to `/sign-in`)
  - `Verify email` (link to `/user-profile`)
- This page is intentionally minimal and consistent with existing app styling.

#### `src/app/user-profile/[[...user-profile]]/page.tsx`
- Adds a Clerk-hosted profile route so blocked users have a direct place to manage/verify email.
- **`<SignedIn><UserProfile ... /></SignedIn>`**
  - Shows profile only for authenticated users.
- **`<SignedOut><RedirectToSignIn /></SignedOut>`**
  - Prevents anonymous access and sends signed-out users to sign-in.

---

### Scope Confirmation
- Implemented: frontend auth flow and route protection.
- Implemented: Clerk-based gating for protected pages.
- Implemented: blocked-user access UX with required actions.
- Not implemented: backend guard changes, `/api/*` behavior changes, business logic/model changes.

---

## PR: Backend Authentication & Authorization (feat/backend-auth)

### Overview
This PR implements backend authentication and authorization enforcement for MVP 1.
All protected API routes require a valid Clerk session AND a verified @stetson.edu email.

---

### Files Changed

#### `.env.local` / `.env.example`
- **`.env.local`**: Contains the actual environment variable values (gitignored).
- **`.env.example`**: Committed reference showing all required environment variables.
- Variables:
  - `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` — Clerk publishable key (used client-side)
  - `CLERK_SECRET_KEY` — Clerk secret key (used server-side)
  - `NEXT_PUBLIC_CLERK_SIGN_IN_URL` / `NEXT_PUBLIC_CLERK_SIGN_UP_URL` — Clerk redirect URLs
  - `DATABASE_URL` — PostgreSQL connection string for Prisma

#### `prisma/schema.prisma`
- Defines the PostgreSQL datasource and Prisma client generator.
- **`User` model**: Local user record linked to Clerk.
  - `id` — UUID primary key (auto-generated).
  - `clerkUserId` — Unique string mapped from Clerk's user ID (`clerk_user_id` column). Ensures one local record per Clerk user.
  - `email` — The user's verified @stetson.edu email address.
  - `createdAt` / `updatedAt` — Timestamps for record creation and last update.
  - `@@map("users")` — Maps the model to a `users` table in PostgreSQL.

#### `prisma.config.ts`
- Auto-generated Prisma config. Loads `DATABASE_URL` from environment via `dotenv/config`.
- Points to `prisma/schema.prisma` and `prisma/migrations` directory.

#### `src/lib/prisma.ts`
- **Singleton Prisma client**.
- Uses `globalThis` caching to prevent multiple PrismaClient instances during Next.js dev hot-reloads.
- `globalForPrisma.prisma` stores the client globally; in production, a fresh instance is created per cold start.

#### `src/lib/auth.ts`
- **`requireStetsonAuth()`** — The core auth guard function.
- **Step 1**: Calls `currentUser()` from `@clerk/nextjs/server` to get the Clerk session user.
  - If `null` → returns `NextResponse` with **401** and `"Authentication required."` message.
- **Step 2**: Iterates `user.emailAddresses` looking for an email where:
  - `verification.status === "verified"` — Email must be verified through Clerk.
  - `emailAddress.toLowerCase().endsWith("@stetson.edu")` — Must be a Stetson University email (case-insensitive).
  - If no matching email → returns `NextResponse` with **403** and `"Access restricted to verified @stetson.edu email addresses."` message.
- **Step 3**: Returns `AuthedUser` object with `clerkUserId` and `primaryStetsonEmail`.
- **Type `AuthResult`**: Discriminated union — either `{ user: AuthedUser }` or `{ error: NextResponse }`. Enables clean pattern matching in route handlers.

#### `src/middleware.ts`
- Exports `clerkMiddleware()` from `@clerk/nextjs/server`.
- **Purpose**: Makes Clerk auth state (session, user) available to all matched routes. Without this, `currentUser()` would return `null` for every request.
- **`config.matcher`**: Applies to all `/api/(.*)` routes and non-static pages. Skips Next.js internals (`_next`) and static assets (images, fonts, etc.).
- **Note**: This middleware does NOT enforce authorization — it only provides session data. Authorization is enforced per-route by `requireStetsonAuth()`.

#### `src/app/layout.tsx`
- Wraps the entire app with `<ClerkProvider>` — required for Clerk to manage sessions.
- Updates metadata title/description to "Desti".
- **Note**: This is the only frontend file touched, and it's the minimal change needed for Clerk to function. No frontend route protection or UI logic is added.

#### `src/app/api/me/route.ts`
- **`GET /api/me`** — Returns the current user's profile.
- **Line-by-line**:
  1. Calls `requireStetsonAuth()` — if it returns an error, that error response is returned immediately (401 or 403).
  2. Calls `prisma.user.findUnique({ where: { clerkUserId } })` to check if a local user already exists.
  3. Calls `prisma.user.upsert()` with:
     - `where: { clerkUserId }` — Matches on the unique Clerk ID.
     - `create: { clerkUserId, email }` — Creates the user if missing.
     - `update: { email }` — Keeps the email in sync if user already exists.
  4. Sets `created = !existingUser` — `true` if this was the first call for this user.
  5. Returns JSON with `clerkUserId`, `primaryVerifiedEmail`, `created`, and `localUser` (safe fields only: id, clerkUserId, email, createdAt, updatedAt).
- **Idempotency**: `upsert` ensures no duplicate users are created even under concurrent requests.

#### `src/app/api/health/route.ts`
- **`GET /api/health`** — Public health-check endpoint. No authentication required.
- Returns `{ status: "ok", timestamp: "..." }`.
- Useful for uptime monitoring, load balancer health checks, and deployment verification.

#### `.gitignore`
- Updated to allow `.env.example` to be committed while still excluding `.env`, `.env.local`, and `*.local` env files.

---

### API Responses Summary

| Endpoint | Auth Required | 401 When | 403 When | 200 Response |
|-----------|--------------|----------|----------|-------------|
| `GET /api/health` | No | — | — | `{ status, timestamp }` |
| `GET /api/me` | Yes | No Clerk session | No verified @stetson.edu email | `{ clerkUserId, primaryVerifiedEmail, created, localUser }` |
