// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Local user record — linked to Clerk via clerkUserId.
model User {
  id          String   @id @default(uuid())
  clerkUserId String   @unique @map("clerk_user_id")
  email       String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  rides        Ride[]        @relation("DriverRides")
  tripRequests TripRequest[] @relation("RiderTripRequests")

  @@map("users")
}

/// Distance category for a ride or trip request.
enum DistanceCategory {
  SHORT
  MEDIUM
  LONG
}

/// Current status of a ride.
enum RideStatus {
  ACTIVE
}

/// Current status of a trip request.
enum TripRequestStatus {
  ACTIVE
  CANCELLED
}

/// Discriminator for the idempotency key table.
enum IdempotencyEntityType {
  RIDE
  TRIP_REQUEST
}

/// A ride offered by a driver.
model Ride {
  id               String           @id @default(uuid())
  driverUserId     String           @map("driver_user_id")
  originText       String           @map("origin_text")
  destinationText  String           @map("destination_text")
  earliestDepartAt DateTime         @map("earliest_depart_at")
  latestDepartAt   DateTime         @map("latest_depart_at")
  distanceCategory DistanceCategory @map("distance_category")
  priceCents       Int              @map("price_cents")
  seatsTotal       Int              @map("seats_total")
  seatsAvailable       Int              @map("seats_available")
  pickupInstructions   String?          @map("pickup_instructions")
  dropoffInstructions  String?          @map("dropoff_instructions")
  preferredDepartAt    DateTime?        @map("preferred_depart_at")
  status               RideStatus       @default(ACTIVE)
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  driver          User             @relation("DriverRides", fields: [driverUserId], references: [clerkUserId])
  idempotencyKeys IdempotencyKey[]

  @@index([earliestDepartAt, id])
  @@map("rides")
}

/// A trip request posted by a rider.
model TripRequest {
  id               String            @id @default(uuid())
  riderUserId      String            @map("rider_user_id")
  originText       String            @map("origin_text")
  destinationText  String            @map("destination_text")
  earliestDesiredAt DateTime         @map("earliest_desired_at")
  latestDesiredAt   DateTime         @map("latest_desired_at")
  distanceCategory DistanceCategory  @map("distance_category")
  seatsNeeded          Int               @map("seats_needed")
  pickupInstructions   String?           @map("pickup_instructions")
  dropoffInstructions  String?           @map("dropoff_instructions")
  preferredDepartAt    DateTime?         @map("preferred_depart_at")
  status               TripRequestStatus @default(ACTIVE)
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")

  rider           User             @relation("RiderTripRequests", fields: [riderUserId], references: [clerkUserId])
  idempotencyKeys IdempotencyKey[]

  @@index([earliestDesiredAt, id])
  @@map("trip_requests")
}

/// Idempotency key mapping — shared across rides and trip requests.
model IdempotencyKey {
  id             String                @id @default(uuid())
  userId         String                @map("user_id")
  idempotencyKey String                @map("idempotency_key")
  entityType     IdempotencyEntityType @map("entity_type")
  rideId         String?               @map("ride_id")
  tripRequestId  String?               @map("trip_request_id")
  createdAt      DateTime              @default(now()) @map("created_at")

  ride        Ride?        @relation(fields: [rideId], references: [id], onDelete: Restrict)
  tripRequest TripRequest? @relation(fields: [tripRequestId], references: [id], onDelete: Restrict)

  @@unique([userId, idempotencyKey, entityType])
  @@map("idempotency_keys")
}
